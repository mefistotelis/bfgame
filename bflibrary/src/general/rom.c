/******************************************************************************/
// Bullfrog Engine Emulation Library - for use to remake classic games like
// Syndicate Wars, Magic Carpet, Genewars or Dungeon Keeper.
/******************************************************************************/
/** @file rom.asm
 *     Implementation of related functions.
 * @par Purpose:
 *     Unknown.
 * @par Comment:
 *     None.
 * @author   Tomasz Lis
 * @date     12 Nov 2008 - 05 Nov 2021
 * @par  Copying and copyrights:
 *     This program is free software; you can redistribute it and/or modify
 *     it under the terms of the GNU General Public License as published by
 *     the Free Software Foundation; either version 2 of the License, or
 *     (at your option) any later version.
 */
/******************************************************************************/
#include "rom.h"
#include "bftypes.h"
#include "bfpalette.h"

long tabwidth = 46;

const ubyte font[] = {
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    4, 0,
    0b01000000,
    0b01000000,
    0b01000000,
    0b00000000,
    0b01000000,
    0b00000000,
    2, 0,
    0b01010000,
    0b01010000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    4, 0,
    0b00101000,
    0b10000000,
    0b00101000,
    0b10000000,
    0b00101000,
    0b00000000,
    6, 0,
    0b00111100,
    0b01010000,
    0b00111000,
    0b00010100,
    0b01111000,
    0b00000000,
    6, 0,
    0b01100100,
    0b01001000,
    0b00010000,
    0b00100100,
    0b01001100,
    0b00000000,
    6, 0,
    0b00100000,
    0b01010000,
    0b00110100,
    0b01001000,
    0b00110100,
    0b00000000,
    6, 0,
    0b00100000,
    0b01000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    3, 0,
    0b00100000,
    0b01000000,
    0b01000000,
    0b01000000,
    0b00100000,
    0b00000000,
    3, 0,
    0b01000000,
    0b00100000,
    0b00100000,
    0b00100000,
    0b01000000,
    0b00000000,
    3, 0,
    0b01010100,
    0b00111000,
    0b10000000,
    0b00111000,
    0b01010100,
    0b00000000,
    6, 0,
    0b00100000,
    0b00100000,
    0b01110000,
    0b00100000,
    0b00100000,
    0b00000000,
    4, 0,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00100000,
    0b01000000,
    3, 0,
    0b00000000,
    0b00000000,
    0b01110000,
    0b00000000,
    0b00000000,
    0b00000000,
    4, 0,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b01000000,
    0b00000000,
    2, 0,
    0b00000100,
    0b00001000,
    0b00010000,
    0b00100000,
    0b01000000,
    0b00000000,
    6, 0,
    0b00110000,
    0b01001000,
    0b01001000,
    0b01001000,
    0b00110000,
    0b00000000,
    5, 0,
    0b00010000,
    0b00110000,
    0b00010000,
    0b00010000,
    0b00111000,
    0b00000000,
    5, 0,
    0b01110000,
    0b00001000,
    0b00110000,
    0b01000000,
    0b01111000,
    0b00000000,
    5, 0,
    0b01110000,
    0b00001000,
    0b00110000,
    0b00001000,
    0b01110000,
    0b00000000,
    5, 0,
    0b01001000,
    0b01001000,
    0b01111000,
    0b00001000,
    0b00001000,
    0b00000000,
    5, 0,
    0b01111000,
    0b01000000,
    0b01110000,
    0b00001000,
    0b01110000,
    0b00000000,
    5, 0,
    0b00111000,
    0b01000000,
    0b01110000,
    0b01001000,
    0b00110000,
    0b00000000,
    5, 0,
    0b01111000,
    0b00010000,
    0b00100000,
    0b00100000,
    0b00100000,
    0b00000000,
    5, 0,
    0b00110000,
    0b01001000,
    0b00110000,
    0b01001000,
    0b00110000,
    0b00000000,
    5, 0,
    0b00110000,
    0b01001000,
    0b00111000,
    0b00001000,
    0b01110000,
    0b00000000,
    5, 0,
    0b00000000,
    0b01000000,
    0b00000000,
    0b01000000,
    0b00000000,
    0b00000000,
    2, 0,
    0b00000000,
    0b00100000,
    0b00000000,
    0b00100000,
    0b01000000,
    0b00000000,
    2, 0,
    0b00010000,
    0b00100000,
    0b01000000,
    0b00100000,
    0b00010000,
    0b00000000,
    4, 0,
    0b00000000,
    0b01110000,
    0b00000000,
    0b01110000,
    0b00000000,
    0b00000000,
    4, 0,
    0b01000000,
    0b00100000,
    0b00010000,
    0b00100000,
    0b01000000,
    0b00000000,
    4, 0,
    0b00111000,
    0b01000100,
    0b00011000,
    0b00000000,
    0b00010000,
    0b00000000,
    6, 0,
    0b00111000,
    0b01010100,
    0b01011000,
    0b01000000,
    0b00111100,
    0b00000000,
    6, 0,
    0b00110000,
    0b01001000,
    0b01111000,
    0b01001000,
    0b01001000,
    0b00000000,
    5, 0,
    0b01110000,
    0b01001000,
    0b01110000,
    0b01001000,
    0b01110000,
    0b00000000,
    5, 0,
    0b00111000,
    0b01000000,
    0b01000000,
    0b01000000,
    0b00111000,
    0b00000000,
    5, 0,
    0b01110000,
    0b01001000,
    0b01001000,
    0b01001000,
    0b01110000,
    0b00000000,
    5, 0,
    0b01111000,
    0b01000000,
    0b01110000,
    0b01000000,
    0b01111000,
    0b00000000,
    5, 0,
    0b01111000,
    0b01000000,
    0b01110000,
    0b01000000,
    0b01000000,
    0b00000000,
    5, 0,
    0b00111000,
    0b01000000,
    0b01011000,
    0b01001000,
    0b00111000,
    0b00000000,
    5, 0,
    0b01001000,
    0b01001000,
    0b01111000,
    0b01001000,
    0b01001000,
    0b00000000,
    5, 0,
    0b01110000,
    0b00100000,
    0b00100000,
    0b00100000,
    0b01110000,
    0b00000000,
    4, 0,
    0b00010000,
    0b00010000,
    0b00010000,
    0b00010000,
    0b01100000,
    0b00000000,
    4, 0,
    0b01001000,
    0b01010000,
    0b01100000,
    0b01010000,
    0b01001000,
    0b00000000,
    5, 0,
    0b01000000,
    0b01000000,
    0b01000000,
    0b01000000,
    0b01111000,
    0b00000000,
    5, 0,
    0b01000100,
    0b01101100,
    0b01010100,
    0b01000100,
    0b01000100,
    0b00000000,
    6, 0,
    0b01001000,
    0b01101000,
    0b01011000,
    0b01001000,
    0b01001000,
    0b00000000,
    5, 0,
    0b00110000,
    0b01001000,
    0b01001000,
    0b01001000,
    0b00110000,
    0b00000000,
    5, 0,
    0b01110000,
    0b01001000,
    0b01110000,
    0b01000000,
    0b01000000,
    0b00000000,
    5, 0,
    0b00110000,
    0b01001000,
    0b01001000,
    0b01010000,
    0b00101000,
    0b00000000,
    5, 0,
    0b01110000,
    0b01001000,
    0b01110000,
    0b01001000,
    0b01001000,
    0b00000000,
    5, 0,
    0b00111000,
    0b01000000,
    0b00110000,
    0b00001000,
    0b01110000,
    0b00000000,
    5, 0,
    0b10000000,
    0b00010000,
    0b00010000,
    0b00010000,
    0b00010000,
    0b00000000,
    6, 0,
    0b01001000,
    0b01001000,
    0b01001000,
    0b01001000,
    0b00110000,
    0b00000000,
    5, 0,
    0b01000100,
    0b01000100,
    0b01000100,
    0b00101000,
    0b00010000,
    0b00000000,
    6, 0,
    0b01000100,
    0b01000100,
    0b01010100,
    0b01101100,
    0b01000100,
    0b00000000,
    6, 0,
    0b01000100,
    0b00101000,
    0b00010000,
    0b00101000,
    0b01000100,
    0b00000000,
    6, 0,
    0b01000100,
    0b00101000,
    0b00010000,
    0b00010000,
    0b00010000,
    0b00000000,
    6, 0,
    0b01111000,
    0b00010000,
    0b00100000,
    0b01000000,
    0b01111000,
    0b00000000,
    6, 0,
    0b01100000,
    0b01000000,
    0b01000000,
    0b01000000,
    0b01100000,
    0b00000000,
    3, 0,
    0b01000000,
    0b00100000,
    0b00010000,
    0b00001000,
    0b00000100,
    0b00000000,
    6, 0,
    0b01100000,
    0b00100000,
    0b00100000,
    0b00100000,
    0b01100000,
    0b00000000,
    3, 0,
    0b00010000,
    0b00101000,
    0b01000100,
    0b00000000,
    0b00000000,
    0b00000000,
    6, 0,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b10000000,
    0b00000000,
    6, 0,
    0b01000000,
    0b00100000,
    0b00010000,
    0b00001000,
    0b00000100,
    0b00000000,
    6, 0,
    0b00000000,
    0b00110000,
    0b01010000,
    0b01010000,
    0b00110000,
    0b00000000,
    4, 0,
    0b01000000,
    0b01100000,
    0b01010000,
    0b01010000,
    0b01100000,
    0b00000000,
    4, 0,
    0b00000000,
    0b00110000,
    0b01000000,
    0b01000000,
    0b00110000,
    0b00000000,
    4, 0,
    0b00010000,
    0b00110000,
    0b01010000,
    0b01010000,
    0b00110000,
    0b00000000,
    4, 0,
    0b00000000,
    0b00110000,
    0b01110000,
    0b01000000,
    0b00110000,
    0b00000000,
    4, 0,
    0b00010000,
    0b00100000,
    0b01110000,
    0b00100000,
    0b00100000,
    0b00100000,
    4, 0,
    0b00000000,
    0b00100000,
    0b01010000,
    0b00110000,
    0b00010000,
    0b01100000,
    4, 0,
    0b01000000,
    0b01100000,
    0b01010000,
    0b01010000,
    0b01010000,
    0b00000000,
    4, 0,
    0b01000000,
    0b00000000,
    0b01000000,
    0b01000000,
    0b01000000,
    0b00000000,
    2, 0,
    0b00100000,
    0b00000000,
    0b00100000,
    0b00100000,
    0b00100000,
    0b01000000,
    3, 0,
    0b01000000,
    0b01000000,
    0b01010000,
    0b01100000,
    0b01010000,
    0b00000000,
    4, 0,
    0b01000000,
    0b01000000,
    0b01000000,
    0b01000000,
    0b01000000,
    0b00000000,
    2, 0,
    0b00000000,
    0b01101000,
    0b01010100,
    0b01000100,
    0b01000100,
    0b00000000,
    6, 0,
    0b00000000,
    0b01100000,
    0b01010000,
    0b01010000,
    0b01010000,
    0b00000000,
    4, 0,
    0b00000000,
    0b00100000,
    0b01010000,
    0b01010000,
    0b00100000,
    0b00000000,
    4, 0,
    0b00000000,
    0b01100000,
    0b01010000,
    0b01010000,
    0b01100000,
    0b01000000,
    4, 0,
    0b00000000,
    0b00110000,
    0b01010000,
    0b01010000,
    0b00110000,
    0b00010000,
    4, 0,
    0b00000000,
    0b01010000,
    0b01100000,
    0b01000000,
    0b01000000,
    0b00000000,
    4, 0,
    0b00000000,
    0b00110000,
    0b01000000,
    0b00010000,
    0b01100000,
    0b00000000,
    4, 0,
    0b00100000,
    0b01110000,
    0b00100000,
    0b00100000,
    0b00010000,
    0b00000000,
    4, 0,
    0b00000000,
    0b01010000,
    0b01010000,
    0b01010000,
    0b00110000,
    0b00000000,
    4, 0,
    0b00000000,
    0b01010000,
    0b01010000,
    0b01010000,
    0b00100000,
    0b00000000,
    4, 0,
    0b00000000,
    0b01000100,
    0b01010100,
    0b01010100,
    0b00101000,
    0b00000000,
    6, 0,
    0b00000000,
    0b01010000,
    0b00100000,
    0b01010000,
    0b01010000,
    0b00000000,
    4, 0,
    0b00000000,
    0b01010000,
    0b01010000,
    0b00110000,
    0b00010000,
    0b01100000,
    4, 0,
    0b00000000,
    0b01110000,
    0b00100000,
    0b01000000,
    0b01110000,
    0b00000000,
    4, 0,
    0b00110000,
    0b00100000,
    0b01000000,
    0b00100000,
    0b00110000,
    0b00000000,
    4, 0,
    0b01000000,
    0b01000000,
    0b01000000,
    0b01000000,
    0b01000000,
    0b01000000,
    2, 0,
    0b01100000,
    0b00100000,
    0b00010000,
    0b00100000,
    0b01100000,
    0b00000000,
    4, 0,
    0b00101000,
    0b01010000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    5, 0,
    0b10000000,
    0b10000000,
    0b10000000,
    0b10000000,
    0b10000000,
    0b10000000,
    6, 0,
    0b10000000,
    0b01000100,
    0b01010100,
    0b01000100,
    0b10000000,
    0b00000000,
    6, 0,
    0b00010000,
    0b00010000,
    0b00111000,
    0b00111000,
    0b10000000,
    0b00000000,
    6, 0,
    0b01000000,
    0b01110000,
    0b10000000,
    0b01110000,
    0b01000000,
    0b00000000,
    6, 0,
    0b10000000,
    0b00111000,
    0b00111000,
    0b00010000,
    0b00010000,
    0b00000000,
    6, 0,
    0b00000100,
    0b00011100,
    0b10000000,
    0b00011100,
    0b00000100,
    0b00000000,
    6, 0,
    0b00010000,
    0b00101000,
    0b01010100,
    0b00111000,
    0b10000000,
    0b00000000,
    6, 0,
    0b01010000,
    0b01101000,
    0b01111100,
    0b01101000,
    0b01010000,
    0b00000000,
    6, 0,
    0b10000000,
    0b00111000,
    0b01010100,
    0b00101000,
    0b00010000,
    0b00000000,
    6, 0,
    0b00010100,
    0b00101100,
    0b01011100,
    0b00101100,
    0b00010100,
    0b00000110,
    0, 0,
};

static void prop_text_qaz(ubyte *o, ubyte chtype, ushort colr)
{
    switch (chtype)
    {
    case 0:
        break;
    case 0b10000000:
        o[0] = colr;
        break;
    case 0b01000000:
        o[1] = colr;
        break;
    case 0b11000000:
        *((ushort *)&o[0]) = colr;
        break;
    case 0b00100000:
        o[2] = colr;
        break;
    case 0b10100000:
        o[0] = colr;
        o[2] = colr;
        break;
    case 0b01100000:
        *((ushort *)&o[1]) = colr;
        break;
    case 0b11100000:
        *((ushort *)&o[0]) = colr;
        o[2] = colr;
        break;
    case 0b00010000:
        o[3] = colr;
        break;
    case 0b10010000:
        o[0] = colr;
        o[3] = colr;
        break;
    case 0b01010000:
        o[1] = colr;
        o[3] = colr;
        break;
    case 0b11010000:
        *((ushort *)&o[0]) = colr;
        o[3] = colr;
        break;
    case 0b00110000:
        *((ushort *)&o[2]) = colr;
        break;
    case 0b10110000:
        o[0] = colr;
        *((ushort *)&o[2]) = colr;
        break;
    case 0b01110000:
        o[1] = colr;
        *((ushort *)&o[2]) = colr;
        break;
    case 0b11110000:
        *((ushort *)&o[0]) = colr;
        *((ushort *)&o[2]) = colr;
        break;
    case 0b00001000:
        o[4] = colr;
        break;
    case 0b10001000:
        o[0] = colr;
        o[4] = colr;
        break;
    case 0b01001000:
        o[1] = colr;
        o[4] = colr;
        break;
    case 0b11001000:
        *((ushort *)&o[0]) = colr;
        o[4] = colr;
        break;
    case 0b00101000:
        o[2] = colr;
        o[4] = colr;
        break;
    case 0b10101000:
        o[0] = colr;
        o[2] = colr;
        o[4] = colr;
        break;
    case 0b01101000:
        *((ushort *)&o[1]) = colr;
        o[4] = colr;
        break;
    case 0b11101000:
        *((ushort *)&o[0]) = colr;
        o[2] = colr;
        o[4] = colr;
        break;
    case 0b00011000:
        *((ushort *)&o[3]) = colr;
        break;
    case 0b10011000:
        o[0] = colr;
        *((ushort *)&o[3]) = colr;
        break;
    case 0b01011000:
        o[1] = colr;
        *((ushort *)&o[3]) = colr;
        break;
    case 0b11011000:
        *((ushort *)&o[0]) = colr;
        *((ushort *)&o[3]) = colr;
        break;
    case 0b00111000:
        *((ushort *)&o[2]) = colr;
        o[4] = colr;
        break;
    case 0b10111000:
        o[0] = colr;
        *((ushort *)&o[2]) = colr;
        o[4] = colr;
        break;
    case 0b01111000:
        *((ushort *)&o[1]) = colr;
        *((ushort *)&o[3]) = colr;
        break;
    case 0b11111000:
        *((ushort *)&o[0]) = colr;
        *((ushort *)&o[2]) = colr;
        o[4] = colr;
        break;
    case 0b00000100:
        o[5] = colr;
        break;
    case 0b10000100:
        o[0] = colr;
        o[5] = colr;
        break;
    case 0b01000100:
        o[1] = colr;
        o[5] = colr;
        break;
    case 0b11000100:
        *((ushort *)&o[0]) = colr;
        o[5] = colr;
        break;
    case 0b00100100:
        o[2] = colr;
        o[5] = colr;
        break;
    case 0b10100100:
        o[0] = colr;
        o[2] = colr;
        o[5] = colr;
        break;
    case 0b01100100:
        *((ushort *)&o[1]) = colr;
        o[5] = colr;
        break;
    case 0b11100100:
        *((ushort *)&o[0]) = colr;
        o[2] = colr;
        o[5] = colr;
        break;
    case 0b00010100:
        o[3] = colr;
        o[5] = colr;
        break;
    case 0b10010100:
        o[0] = colr;
        o[3] = colr;
        o[5] = colr;
        break;
    case 0b01010100:
        o[1] = colr;
        o[3] = colr;
        o[5] = colr;
        break;
    case 0b11010100:
        *((ushort *)&o[0]) = colr;
        o[3] = colr;
        o[5] = colr;
        break;
    case 0b00110100:
        *((ushort *)&o[2]) = colr;
        o[5] = colr;
        break;
    case 0b10110100:
        o[0] = colr;
        *((ushort *)&o[2]) = colr;
        o[5] = colr;
        break;
    case 0b01110100:
        o[1] = colr;
        *((ushort *)&o[2]) = colr;
        o[5] = colr;
        break;
    case 0b11110100:
        *((ushort *)&o[0]) = colr;
        *((ushort *)&o[2]) = colr;
        o[5] = colr;
        break;
    case 0b00001100:
        *((ushort *)&o[4]) = colr;
        break;
    case 0b10001100:
        o[0] = colr;
        *((ushort *)&o[4]) = colr;
        break;
    case 0b01001100:
        o[1] = colr;
        *((ushort *)&o[4]) = colr;
        break;
    case 0b11001100:
        *((ushort *)&o[0]) = colr;
        *((ushort *)&o[4]) = colr;
        break;
    case 0b00101100:
        o[2] = colr;
        *((ushort *)&o[4]) = colr;
        break;
    case 0b10101100:
        o[0] = colr;
        o[2] = colr;
        *((ushort *)&o[4]) = colr;
        break;
    case 0b01101100:
        *((ushort *)&o[1]) = colr;
        *((ushort *)&o[4]) = colr;
        break;
    case 0b11101100:
        *((ushort *)&o[0]) = colr;
        o[2] = colr;
        *((ushort *)&o[4]) = colr;
        break;
    case 0b00011100:
        o[3] = colr;
        *((ushort *)&o[4]) = colr;
        break;
    case 0b10011100:
        o[0] = colr;
        o[3] = colr;
        *((ushort *)&o[4]) = colr;
        break;
    case 0b01011100:
        o[1] = colr;
        o[3] = colr;
        *((ushort *)&o[4]) = colr;
        break;
    case 0b11011100:
        *((ushort *)&o[0]) = colr;
        o[3] = colr;
        *((ushort *)&o[4]) = colr;
        break;
    case 0b00111100:
        *((ushort *)&o[2]) = colr;
        *((ushort *)&o[4]) = colr;
        break;
    case 0b10111100:
        o[0] = colr;
        *((ushort *)&o[2]) = colr;
        *((ushort *)&o[4]) = colr;
        break;
    case 0b01111100:
        o[1] = colr;
        *((ushort *)&o[2]) = colr;
        *((ushort *)&o[4]) = colr;
        break;
    case 0b11111100:
        *((ushort *)&o[0]) = colr;
        *((ushort *)&o[2]) = colr;
        *((ushort *)&o[4]) = colr;
        break;
    }
}

static inline short prop_text_draw_char(ubyte *o, ubyte c, long scanline, ushort colr)
{
    ulong fpos; // pos within font data
    short fln; // line within font data

    fpos = 8 * ((c - 32) & 0xFF);
    for (fln = 6; fln > 0; fln--) {
        prop_text_qaz(o, font[fpos], colr);
        o += scanline;
        fpos++;
    }
    return font[fpos];
}

void prop_text(const char *text, TbPixel *out, long scanline, TbPixel colour)
{
    TbPixel *obeg; // current line begin in output buffer
    TbPixel *o; // current pos in output buffer
    ushort colr; // Colour expanded to 16 bits
    const ubyte *pch; // Pointer to currently drawn character
    ulong linesize; // size of one line within the output buffer

    linesize = 6 * scanline;
    colr = (colour << 8) + colour;
    pch = (const ubyte *)text;
    obeg = out;
    o = obeg;

    while (true)
    {
        ulong w;
        ubyte c;
        TbPixel *otmp;
        short chshift;

        c = *pch++;
        switch (c)
        {
        case 9: // Horizontal Tab
            w = tabwidth;
            do
            {
                otmp = &obeg[w];
                w += tabwidth;
            }
            while (otmp <= o);
            o = otmp;
            break;
        case 10: // Line Feed
            obeg += linesize;
            o = obeg;
            break;
        default: // Normal character
            chshift = prop_text_draw_char(o, c, scanline, colr);
            o += chshift;
            break;
        case 0: // NULL char means end
            return;
        }
    }
}

void make_fade_table(const ubyte *pal, ubyte *out, ubyte cr, ubyte cg, ubyte cb,
  ubyte ir, ubyte ig, ubyte ib)
{
    const ubyte *p;
    ubyte *t;
    short k;

    p = pal;
    t = out;
    for (k = 256; k > 0; k--)
    {
        ubyte r, g, b;

        r = ((ushort)(ir * (short)(cr - p[0])) >> 8) + p[0];
        g = ((ushort)(ig * (short)(cg - p[1])) >> 8) + p[1];
        b = ((ushort)(ib * (short)(cb - p[2])) >> 8) + p[2];
        *t = LbPaletteFindColourHalfWaged(pal, r, g, b);
        t++;
        p += 3;
    }
}


/******************************************************************************/
